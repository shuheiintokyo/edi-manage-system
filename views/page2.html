<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EDI Management System - Page 2</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <nav class="navbar">
        <div class="nav-brand">
            <h2>EDI Management System</h2>
        </div>
        <div class="nav-links">
            <a href="/pages/page1">Page 1</a>
            <a href="/pages/page2" class="active">Page 2</a>
            <a href="/pages/page3">Page 3</a>
        </div>
        <div class="nav-user">
            <span class="username">Welcome, <span id="current-user">admin</span></span>
            <form method="POST" action="/auth/logout" style="display: inline;">
                <button type="submit" class="logout-btn">Logout</button>
            </form>
        </div>
    </nav>

    <main class="main-content">
        <div class="page-header">
            <h1>Sample Page 2</h1>
            <p>Data management and processing with database logging.</p>
        </div>
        
        <div class="content-grid">
            <div class="card">
                <h3>Data Processing</h3>
                <p>Process data with automatic database logging and activity tracking.</p>
                <div class="form-group">
                    <label for="sample-input">Sample Input:</label>
                    <textarea id="sample-input" placeholder="Enter some data to process..." rows="3" style="width: 100%; padding: 0.5rem; border: 2px solid #ddd; border-radius: 5px; font-family: inherit;"></textarea>
                </div>
                <button class="primary-btn" onclick="processData()" id="process-btn">Process Data</button>
                <div id="processing-result" class="result-area" style="display: none;"></div>
            </div>
            
            <div class="card">
                <h3>System Information</h3>
                <table class="info-table">
                    <tr>
                        <td>Current Page:</td>
                        <td>Page 2 - Data Processing</td>
                    </tr>
                    <tr>
                        <td>User:</td>
                        <td id="table-user">admin</td>
                    </tr>
                    <tr>
                        <td>Session Time:</td>
                        <td id="session-time">Active</td>
                    </tr>
                    <tr>
                        <td>Last Access:</td>
                        <td class="timestamp"></td>
                    </tr>
                    <tr>
                        <td>Database Status:</td>
                        <td id="db-status">Checking...</td>
                    </tr>
                </table>
            </div>
        </div>
    </main>

    <script src="/js/main.js"></script>
    <script>
        // Load user info and check database status
        async function loadUserInfo() {
            try {
                const response = await fetch('/auth/status');
                const data = await response.json();
                
                if (data.username) {
                    document.getElementById('current-user').textContent = data.username;
                    document.getElementById('table-user').textContent = data.username;
                }
                
                // Update database status
                const dbStatus = document.getElementById('db-status');
                if (data.database === 'connected') {
                    dbStatus.innerHTML = '<span style="color: #27ae60;">✓ Connected</span>';
                } else {
                    dbStatus.innerHTML = '<span style="color: #f39c12;">⚠ Not configured</span>';
                }
                
                // Update session time
                if (data.loginTime) {
                    const loginTime = new Date(data.loginTime);
                    const now = new Date();
                    const minutes = Math.floor((now - loginTime) / 60000);
                    document.getElementById('session-time').textContent = `Active (${minutes}m)`;
                }
            } catch (error) {
                console.error('Error loading user status:', error);
                document.getElementById('db-status').innerHTML = '<span style="color: #e74c3c;">✗ Error</span>';
            }
        }
        
        // Data processing function with database integration
        async function processData() {
            const input = document.getElementById('sample-input').value;
            const resultDiv = document.getElementById('processing-result');
            const processBtn = document.getElementById('process-btn');
            
            if (!input.trim()) {
                alert('Please enter some data to process');
                return;
            }
            
            // Show loading state
            processBtn.textContent = 'Processing...';
            processBtn.disabled = true;
            
            try {
                const response = await fetch('/pages/api/process-data', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ data: input })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    
                    resultDiv.innerHTML = `
                        <h4>✅ Processing Result:</h4>
                        <div style="background: #f8f9fa; padding: 1rem; border-radius: 5px; margin: 0.5rem 0;">
                            <p><strong>Original:</strong> "${result.original}"</p>
                            <p><strong>Processed:</strong> "${result.processed}"</p>
                            <p><strong>Length:</strong> ${result.length} characters</p>
                            <p><strong>Processed by:</strong> ${result.processedBy}</p>
                            <p><strong>Timestamp:</strong> ${new Date(result.timestamp).toLocaleString()}</p>
                        </div>
                        <p style="color: #27ae60; font-size: 0.9rem;">
                            ✓ Activity logged to database
                        </p>
                    `;
                    resultDiv.style.display = 'block';
                } else {
                    const error = await response.json();
                    resultDiv.innerHTML = `
                        <h4 style="color: #e74c3c;">❌ Processing Failed:</h4>
                        <p style="color: #e74c3c;">${error.error || 'Unknown error occurred'}</p>
                    `;
                    resultDiv.style.display = 'block';
                }
            } catch (error) {
                console.error('Processing error:', error);
                resultDiv.innerHTML = `
                    <h4 style="color: #e74c3c;">❌ Network Error:</h4>
                    <p style="color: #e74c3c;">Failed to connect to processing server</p>
                `;
                resultDiv.style.display = 'block';
            } finally {
                // Reset button state
                processBtn.textContent = 'Process Data';
                processBtn.disabled = false;
            }
        }
        
        // Allow Enter key to process data
        document.getElementById('sample-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && e.ctrlKey) {
                processData();
            }
        });
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            // Update timestamp
            document.querySelector('.timestamp').textContent = new Date().toLocaleString();
            
            // Load user info
            loadUserInfo();
            
            // Add helpful hint
            const inputField = document.getElementById('sample-input');
            inputField.addEventListener('focus', function() {
                if (!this.value) {
                    this.placeholder = 'Try entering some text... (Ctrl+Enter to process)';
                }
            });
            
            inputField.addEventListener('blur', function() {
                this.placeholder = 'Enter some data to process...';
            });
        });
    </script>
</body>
</html>