<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EDI Management System - Page 3</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <nav class="navbar">
        <div class="nav-brand">
            <h2>EDI Management System</h2>
        </div>
        <div class="nav-links">
            <a href="/pages/page1">Page 1</a>
            <a href="/pages/page2">Page 2</a>
            <a href="/pages/page3" class="active">Page 3</a>
            <a href="/edi/dashboard">EDI Dashboard</a>
        </div>
        <div class="nav-user">
            <span class="username">Welcome, <span id="current-user">admin</span></span>
            <form method="POST" action="/auth/logout" style="display: inline;">
                <button type="submit" class="logout-btn">Logout</button>
            </form>
        </div>
    </nav>

    <main class="main-content">
        <div class="page-header">
            <h1>Sample Page 3</h1>
            <p>Reports and analytics with real-time database activity logs.</p>
        </div>
        
        <div class="content-grid">
            <div class="card full-width">
                <h3>Activity Report</h3>
                <p>Real-time activity logs from the database with full audit trail.</p>
                
                <div class="report-controls">
                    <button class="primary-btn" onclick="loadActivityLog()" id="load-log-btn">Load Activity Log</button>
                    <button class="secondary-btn" onclick="exportReport()">Export Report</button>
                    <span id="log-status" style="margin-left: 1rem; color: #666; font-size: 0.9rem;"></span>
                </div>
                
                <div id="activity-log" class="log-container">
                    <div class="log-entry">
                        <span class="log-time">Ready</span>
                        <span class="log-action">SYSTEM_READY</span>
                        <span class="log-details">Click "Load Activity Log" to see current database activities</span>
                    </div>
                </div>
                
                <div id="log-pagination" style="margin-top: 1rem; text-align: center; display: none;">
                    <button class="secondary-btn" onclick="loadPreviousPage()">← Previous</button>
                    <span id="page-info" style="margin: 0 1rem;">Page 1 of 1</span>
                    <button class="secondary-btn" onclick="loadNextPage()">Next →</button>
                </div>
            </div>
            
            <div class="card">
                <h3>Quick Actions</h3>
                <div class="action-buttons">
                    <button class="action-btn" onclick="performSystemAction('refresh_data')">Refresh Data</button>
                    <button class="action-btn" onclick="performSystemAction('clear_cache')">Clear Cache</button>
                    <button class="action-btn" onclick="performSystemAction('show_help')">Show Help</button>
                </div>
                <div id="action-result" style="margin-top: 1rem; padding: 0.5rem; background: #f8f9fa; border-radius: 5px; display: none;"></div>
            </div>
            
            <div class="card">
                <h3>System Status</h3>
                <div class="status-indicators">
                    <div class="status-item">
                        <span class="status-light green"></span>
                        <span>Application Running</span>
                    </div>
                    <div class="status-item">
                        <span class="status-light green"></span>
                        <span>Session Active</span>
                    </div>
                    <div class="status-item">
                        <span class="status-light" id="db-status-light"></span>
                        <span id="db-status-text">Database: Checking...</span>
                    </div>
                </div>
                
                <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #eee;">
                    <button class="secondary-btn" onclick="checkSystemHealth()" style="width: 100%;">Check System Health</button>
                </div>
            </div>
        </div>
    </main>

    <script src="/js/main.js"></script>
    <script>
        let currentPage = 1;
        let totalPages = 1;
        
        // Load user info and check system status
        async function loadUserInfo() {
            try {
                const response = await fetch('/auth/status');
                const data = await response.json();
                
                if (data.username) {
                    document.getElementById('current-user').textContent = data.username;
                }
                
                // Update database status indicator
                const dbLight = document.getElementById('db-status-light');
                const dbText = document.getElementById('db-status-text');
                
                if (data.database === 'connected') {
                    dbLight.className = 'status-light green';
                    dbText.textContent = 'Database: Connected';
                } else {
                    dbLight.className = 'status-light yellow';
                    dbText.textContent = 'Database: Not configured';
                }
            } catch (error) {
                console.error('Error loading user status:', error);
                const dbLight = document.getElementById('db-status-light');
                const dbText = document.getElementById('db-status-text');
                dbLight.className = 'status-light red';
                dbText.textContent = 'Database: Error checking status';
            }
        }
        
        // Load activity log from database
        async function loadActivityLog(page = 1) {
            const logContainer = document.getElementById('activity-log');
            const logStatus = document.getElementById('log-status');
            const loadBtn = document.getElementById('load-log-btn');
            
            // Show loading state
            loadBtn.textContent = 'Loading...';
            loadBtn.disabled = true;
            logStatus.textContent = 'Loading activity log...';
            
            try {
                const response = await fetch(`/pages/api/activity-log?page=${page}&limit=10`);
                const data = await response.json();
                
                if (data.activities && data.activities.length > 0) {
                    logContainer.innerHTML = data.activities.map(activity => `
                        <div class="log-entry">
                            <span class="log-time">${new Date(activity.timestamp).toLocaleTimeString()}</span>
                            <span class="log-action">${activity.action}</span>
                            <span class="log-details">
                                ${activity.action_description}
                                ${activity.username ? ` (${activity.username})` : ''}
                            </span>
                        </div>
                    `).join('');
                    
                    // Update pagination
                    if (data.pagination) {
                        currentPage = data.pagination.page;
                        totalPages = data.pagination.totalPages;
                        
                        document.getElementById('page-info').textContent = 
                            `Page ${currentPage} of ${totalPages} (${data.pagination.total} total)`;
                        document.getElementById('log-pagination').style.display = 
                            totalPages > 1 ? 'block' : 'none';
                    }
                    
                    logStatus.textContent = `Loaded ${data.activities.length} activities`;
                } else {
                    logContainer.innerHTML = `
                        <div class="log-entry">
                            <span class="log-time">${new Date().toLocaleTimeString()}</span>
                            <span class="log-action">NO_DATA</span>
                            <span class="log-details">No activity logs found in database</span>
                        </div>
                    `;
                    logStatus.textContent = 'No activities found';
                }
            } catch (error) {
                console.error('Error loading activity log:', error);
                logContainer.innerHTML = `
                    <div class="log-entry">
                        <span class="log-time">${new Date().toLocaleTimeString()}</span>
                        <span class="log-action">ERROR</span>
                        <span class="log-details">Failed to load activity logs from database</span>
                    </div>
                `;
                logStatus.textContent = 'Error loading activity log';
            } finally {
                loadBtn.textContent = 'Refresh Log';
                loadBtn.disabled = false;
            }
        }
        
        // Pagination functions
        function loadPreviousPage() {
            if (currentPage > 1) {
                loadActivityLog(currentPage - 1);
            }
        }
        
        function loadNextPage() {
            if (currentPage < totalPages) {
                loadActivityLog(currentPage + 1);
            }
        }
        
        // Perform system actions with database logging
        async function performSystemAction(action) {
            const resultDiv = document.getElementById('action-result');
            
            try {
                const response = await fetch('/pages/api/system-action', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ action })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    
                    resultDiv.innerHTML = `
                        <div style="color: #27ae60;">
                            <strong>✓ ${result.message}</strong>
                            ${result.helpTopics ? `
                                <ul style="margin: 0.5rem 0; padding-left: 1rem;">
                                    ${result.helpTopics.map(topic => `<li>${topic}</li>`).join('')}
                                </ul>
                            ` : ''}
                            <small style="color: #666;">
                                Action logged at ${new Date(result.timestamp).toLocaleString()}
                            </small>
                        </div>
                    `;
                    resultDiv.style.display = 'block';
                    
                    // Auto-refresh activity log if it's already loaded
                    if (document.getElementById('load-log-btn').textContent === 'Refresh Log') {
                        setTimeout(() => loadActivityLog(currentPage), 1000);
                    }
                } else {
                    const error = await response.json();
                    resultDiv.innerHTML = `
                        <div style="color: #e74c3c;">
                            <strong>❌ Action Failed:</strong> ${error.error}
                        </div>
                    `;
                    resultDiv.style.display = 'block';
                }
            } catch (error) {
                console.error('System action error:', error);
                resultDiv.innerHTML = `
                    <div style="color: #e74c3c;">
                        <strong>❌ Network Error:</strong> Failed to perform system action
                    </div>
                `;
                resultDiv.style.display = 'block';
            }
        }
        
        // Check system health
        async function checkSystemHealth() {
            try {
                const response = await fetch('/auth/health');
                const health = await response.json();
                
                const dbLight = document.getElementById('db-status-light');
                const dbText = document.getElementById('db-status-text');
                
                if (health.status === 'healthy') {
                    dbLight.className = 'status-light green';
                    dbText.textContent = 'Database: Healthy ✓';
                } else {
                    dbLight.className = 'status-light red';
                    dbText.textContent = 'Database: Unhealthy ✗';
                }
                
                // Show health check result
                const resultDiv = document.getElementById('action-result');
                resultDiv.innerHTML = `
                    <div style="color: ${health.status === 'healthy' ? '#27ae60' : '#e74c3c'};">
                        <strong>System Health Check:</strong><br>
                        Status: ${health.status}<br>
                        Database: ${health.database}<br>
                        Checked: ${new Date(health.timestamp).toLocaleString()}
                    </div>
                `;
                resultDiv.style.display = 'block';
            } catch (error) {
                console.error('Health check error:', error);
                document.getElementById('db-status-light').className = 'status-light red';
                document.getElementById('db-status-text').textContent = 'Database: Health check failed';
            }
        }
        
        // Export report function
        function exportReport() {
            // In a real implementation, this would generate and download a report
            const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
            const filename = `activity-report-${timestamp}.txt`;
            
            // Create a simple text report
            const reportContent = `EDI Management System Activity Report
Generated: ${new Date().toLocaleString()}
Page: ${currentPage} of ${totalPages}

Recent Activities:
${Array.from(document.querySelectorAll('.log-entry')).map(entry => {
    const time = entry.querySelector('.log-time').textContent;
    const action = entry.querySelector('.log-action').textContent;
    const details = entry.querySelector('.log-details').textContent;
    return `${time} | ${action} | ${details}`;
}).join('\n')}

Report End`;
            
            // Create and download the file
            const blob = new Blob([reportContent], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            // Log the export action
            performSystemAction('export_report');
        }
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadUserInfo();
            
            // Auto-load activity log after a short delay
            setTimeout(() => {
                loadActivityLog();
            }, 1000);
        });
    </script>
</body>
</html>