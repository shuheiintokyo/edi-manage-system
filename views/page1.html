<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EDI Management System - Page 1</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <nav class="navbar">
        <div class="nav-brand">
            <h2>EDI Management System</h2>
        </div>
        <div class="nav-links">
            <a href="/pages/page1" class="active">Page 1</a>
            <a href="/pages/page2">Page 2</a>
            <a href="/pages/page3">Page 3</a>
        </div>
        <div class="nav-user">
            <span class="username">Welcome, <span id="current-user">admin</span></span>
            <form method="POST" action="/auth/logout" style="display: inline;">
                <button type="submit" class="logout-btn">Logout</button>
            </form>
        </div>
    </nav>

    <main class="main-content">
        <div class="page-header">
            <h1>Sample Page 1</h1>
            <p>This is the first sample page of the EDI Management System with live database integration.</p>
        </div>
        
        <div class="content-grid">
            <div class="card">
                <h3>Dashboard Overview</h3>
                <p>Real-time statistics from the database:</p>
                <div class="stats" id="dashboard-stats">
                    <div class="stat-item">
                        <span class="stat-number" id="total-records">--</span>
                        <span class="stat-label">Total Records</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number" id="active-sessions">--</span>
                        <span class="stat-label">Active Sessions</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number" id="system-pages">--</span>
                        <span class="stat-label">System Pages</span>
                    </div>
                </div>
                <div style="margin-top: 1rem; font-size: 0.9rem; color: #666;">
                    <span id="stats-status">Loading statistics...</span>
                </div>
            </div>
            
            <div class="card">
                <h3>Recent Activities</h3>
                <ul id="recent-activities">
                    <li>Loading recent activities...</li>
                </ul>
                <button class="secondary-btn" onclick="refreshActivities()" style="margin-top: 1rem;">Refresh Activities</button>
            </div>
        </div>
    </main>

    <script src="/js/main.js"></script>
    <script>
        let statsInterval;
        
        // Load dashboard statistics
        async function loadDashboardStats() {
            try {
                const response = await fetch('/pages/api/dashboard-stats');
                const stats = await response.json();
                
                document.getElementById('total-records').textContent = stats.total_records || 0;
                document.getElementById('active-sessions').textContent = stats.active_sessions || 0;
                document.getElementById('system-pages').textContent = stats.system_pages || 3;
                
                document.getElementById('stats-status').textContent = 
                    `Last updated: ${new Date().toLocaleTimeString()}`;
            } catch (error) {
                console.error('Error loading dashboard stats:', error);
                document.getElementById('stats-status').textContent = 
                    'Error loading statistics - using demo data';
                
                // Fallback to demo data
                document.getElementById('total-records').textContent = '42';
                document.getElementById('active-sessions').textContent = '12';
                document.getElementById('system-pages').textContent = '3';
            }
        }
        
        // Load recent activities
        async function loadRecentActivities() {
            try {
                const response = await fetch('/pages/api/recent-activities');
                const activities = await response.json();
                
                const activitiesList = document.getElementById('recent-activities');
                
                if (activities.length > 0) {
                    activitiesList.innerHTML = activities.slice(0, 5).map(activity => `
                        <li>
                            <strong>${activity.username || 'System'}:</strong> 
                            ${activity.action_description}
                            <br>
                            <small style="color: #666;">
                                ${new Date(activity.timestamp).toLocaleString()}
                            </small>
                        </li>
                    `).join('');
                } else {
                    activitiesList.innerHTML = '<li>No recent activities found</li>';
                }
            } catch (error) {
                console.error('Error loading recent activities:', error);
                document.getElementById('recent-activities').innerHTML = `
                    <li>
                        <strong>System:</strong> Page accessed at ${new Date().toLocaleTimeString()}
                    </li>
                    <li>
                        <strong>Admin:</strong> User logged in successfully
                    </li>
                    <li>
                        <strong>System:</strong> Database connection established
                    </li>
                `;
            }
        }
        
        // Refresh activities manually
        function refreshActivities() {
            loadRecentActivities();
        }
        
        // Load user info
        async function loadUserInfo() {
            try {
                const response = await fetch('/auth/status');
                const data = await response.json();
                
                if (data.username) {
                    document.getElementById('current-user').textContent = data.username;
                }
            } catch (error) {
                console.error('Error loading user status:', error);
            }
        }
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadUserInfo();
            loadDashboardStats();
            loadRecentActivities();
            
            // Auto-refresh stats every 30 seconds
            statsInterval = setInterval(() => {
                loadDashboardStats();
                loadRecentActivities();
            }, 30000);
        });
        
        // Cleanup interval when page unloads
        window.addEventListener('beforeunload', function() {
            if (statsInterval) {
                clearInterval(statsInterval);
            }
        });
    </script>
</body>
</html>